<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE BMS REMOTE | TABBED EDITION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link href="https://fonts.cdnfonts.com/css/bauhaus-93" rel="stylesheet">
    <link rel="manifest" id="my-manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;800&display=swap');
        
        :root { 
            --accent: #f59e0b; 
            --bg: #020408;
            --glass: rgba(10, 14, 23, 0.7);
        }

        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background: var(--bg); color: #f8fafc;
            background-image: linear-gradient(to bottom, rgba(2, 4, 8, 0.9), rgba(2, 4, 8, 1)),
                              url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            min-height: 100vh;
        }

        .glass-panel { 
            background: var(--glass); backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 24px; 
        }

        .big-number { font-family: 'JetBrains Mono', monospace; font-weight: 800; letter-spacing: -0.05em; }
        .label-tech { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.2em; color: #475569; }
        
        .tab-content { display: none; animation: slideUp 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .nav-bar { background: rgba(10, 14, 23, 0.9); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.1); }
        .tab-btn { color: #64748b; transition: all 0.3s; position: relative; }
        .tab-btn.active { color: #f59e0b; }
        .tab-btn.active::after { content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 20px; height: 3px; background: #f59e0b; border-radius: 10px; }

        .dibi-box { height: 2.5rem; width: 2.5rem; background: linear-gradient(135deg, #ffbd44 0%, #ff8900 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .dibi-text { font-family: 'Bauhaus 93', sans-serif; font-size: 1.1rem; color: #000; font-weight: bold; }

        #historyContent.collapsed { max-height: 0; opacity: 0; overflow: hidden; }
        #historyContent.expanded { max-height: 300px; opacity: 1; }
        .history-entry { font-family: 'JetBrains Mono', monospace; font-size: 10px; border-bottom: 1px solid rgba(255,255,255,0.03); padding: 4px 0; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(20px); }
    </style>
</head>
<body class="pb-24">

    <nav class="p-6 flex justify-between items-center sticky top-0 z-40 bg-[#020408]/80 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="dibi-box"><span class="dibi-text">dibi</span></div>
            <div>
                <h1 class="text-lg font-bold tracking-tighter">CORE<span class="text-amber-500">.</span>REMOTE</h1>
                <p id="lastUpdate" class="text-[8px] font-mono text-slate-500 uppercase tracking-widest">Connecting Cloud...</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div id="statusPulse" class="h-2 w-2 rounded-full bg-amber-500 animate-pulse"></div>
            <button onclick="openCfg()" class="p-2 bg-white/5 rounded-xl border border-white/10">‚öôÔ∏è</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4">
        
        <div id="tab-home" class="tab-content active space-y-4">
            <div class="glass-panel p-8 flex flex-col items-center relative overflow-hidden">
                <span class="label-tech mb-6">Energy Level</span>
                <div class="relative flex items-center justify-center">
                    <svg class="w-48 h-48 transform -rotate-90">
                        <circle cx="96" cy="96" r="85" stroke="currentColor" stroke-width="6" fill="transparent" class="text-white/5" />
                        <circle id="socCircle" cx="96" cy="96" r="85" stroke="#f59e0b" stroke-width="10" fill="transparent" stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round" style="transition: stroke-dashoffset 0.8s ease;" />
                    </svg>
                    <div class="absolute text-center">
                        <span id="soc" class="big-number text-7xl">0</span>
                        <span class="text-xl font-light text-slate-500">%</span>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <p id="time-remaining-value" class="big-number text-[10px] text-slate-400">Waktu Sisa: --</p>
                </div>
                <div class="grid grid-cols-2 gap-8 mt-8 w-full border-t border-white/5 pt-6 text-center">
                    <div><p class="label-tech">Current (A)</p><p class="big-number text-2xl text-amber-500" id="current">0.00</p></div>
                    <div class="border-l border-white/5"><p class="label-tech">Load (W)</p><p class="big-number text-2xl text-blue-500" id="power">0</p></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div id="rChg" class="glass-panel p-4 flex items-center justify-center gap-3 opacity-20"><span class="text-lg">‚ö°</span><span class="label-tech">Charging</span></div>
                <div id="rDis" class="glass-panel p-4 flex items-center justify-center gap-3 opacity-20"><span class="text-lg">üîå</span><span class="label-tech">Discharge</span></div>
            </div>

            <div id="errorCard" class="glass-panel p-6 border-l-4 border-emerald-500 flex flex-col gap-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div id="statusDot" class="h-3 w-3 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]"></div>
                        <div><p class="label-tech">Status</p><h3 id="errText" class="big-number text-sm uppercase text-emerald-500">System Secure</h3></div>
                    </div>
                    <button onclick="toggleLog()" class="px-3 py-1 bg-white/5 rounded-lg border border-white/10 text-[8px] label-tech text-white">Log</button>
                </div>
                <div id="historyContent" class="collapsed border-t border-white/5 pt-4">
                    <div id="securityHistory" class="max-h-32 overflow-y-auto pr-2">
                        <div class="history-entry text-slate-600 italic">Menunggu telemetri...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-cells" class="tab-content space-y-4">
            <div class="glass-panel p-6">
                <div class="flex justify-between items-center mb-6">
                    <span class="label-tech">Cell Voltages</span>
                    <span id="vTotal" class="big-number text-xl text-white">0.00V</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/5 p-4 rounded-xl text-center"><p class="label-tech !text-[7px]">C1</p><p id="v1" class="big-number text-lg">0.00</p></div>
                    <div class="bg-white/5 p-4 rounded-xl text-center"><p class="label-tech !text-[7px]">C2</p><p id="v2" class="big-number text-lg">0.00</p></div>
                    <div class="bg-white/5 p-4 rounded-xl text-center"><p class="label-tech !text-[7px]">C3</p><p id="v3" class="big-number text-lg">0.00</p></div>
                    <div class="bg-white/5 p-4 rounded-xl text-center"><p class="label-tech !text-[7px]">C4</p><p id="v4" class="big-number text-lg">0.00</p></div>
                </div>
            </div>
            <div class="glass-panel p-6">
                <span class="label-tech">Capacity Cycle</span>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div><p class="label-tech !text-[7px] opacity-50">Wh Now</p><p id="whNow" class="big-number text-xl text-blue-400">0</p></div>
                    <div><p class="label-tech !text-[7px] opacity-50">SOH</p><p id="soh" class="big-number text-xl text-blue-400">0%</p></div>
                </div>
                <div class="mt-4 pt-4 border-t border-white/5 flex justify-between">
                    <div><p class="label-tech !text-[7px] opacity-50">Cycles</p><p id="cycles" class="big-number text-xl">0</p></div>
                    <div class="text-right"><p class="label-tech !text-[7px] opacity-50">Usage</p><p id="usagePer" class="big-number text-xl text-amber-500">0%</p></div>
                </div>
            </div>
        </div>

        <div id="tab-thermal" class="tab-content space-y-4">
            <div class="glass-panel p-6">
                <span class="label-tech">Temperature Sensors</span>
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <div class="bg-white/5 p-6 rounded-2xl flex justify-between items-center">
                        <div><p class="label-tech !text-[8px]">Mosfet Unit</p><p id="tMos" class="big-number text-4xl">0¬∞C</p></div>
                        <div class="h-12 w-1 bg-blue-500 rounded-full"></div>
                    </div>
                    <div class="bg-white/5 p-6 rounded-2xl flex justify-between items-center border-l-4 border-orange-500">
                        <div><p class="label-tech !text-[8px]">Battery Pack</p><p id="tBatt" class="big-number text-4xl text-orange-500">0¬∞C</p></div>
                        <div class="h-12 w-1 bg-orange-500 rounded-full"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-charts" class="tab-content space-y-4">
            <div class="glass-panel p-4">
                <div class="flex justify-between items-center mb-4">
                    <select id="chartDuration" onchange="window.handleDurationChange()" class="bg-black/50 border border-white/10 rounded-lg px-2 py-1 text-[10px] label-tech text-white outline-none">
                        <option value="live">Live Stream</option>
                        <option value="12h">Last 12 Hours</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                    </select>
                    <div id="progressContainer" class="hidden w-20 h-1 bg-white/5 rounded-full overflow-hidden">
                        <div id="syncProgressBar" class="h-full bg-amber-500" style="width: 0%"></div>
                    </div>
                </div>
                <div class="h-72 relative"><canvas id="unifiedChart"></canvas></div>
                <div id="chartFilters" class="flex flex-wrap gap-2 mt-4 justify-center">
                    <button onclick="toggleDataset(0)" id="btn-0" class="px-2 py-1 rounded-full border border-blue-500/50 text-[7px] font-bold text-blue-400">LOAD</button>
                    <button onclick="toggleDataset(1)" id="btn-1" class="px-2 py-1 rounded-full border border-emerald-500/50 text-[7px] font-bold text-emerald-400">VOLT</button>
                    <button onclick="toggleDataset(2)" id="btn-2" class="px-2 py-1 rounded-full border border-orange-500/50 text-[7px] font-bold text-orange-400">AMP</button>
                    <button onclick="toggleDataset(3)" id="btn-3" class="px-2 py-1 rounded-full border border-red-500/50 text-[7px] font-bold text-red-400 opacity-30 grayscale">T-MOS</button>
                    <button onclick="toggleDataset(4)" id="btn-4" class="px-2 py-1 rounded-full border border-purple-500/50 text-[7px] font-bold text-purple-400 opacity-30 grayscale">T-BATT</button>
                </div>
            </div>
            <div class="glass-panel p-6 grid grid-cols-2 gap-4">
                <div><p class="label-tech !text-[7px] text-emerald-500">Wh In (+)</p><p id="whPos" class="big-number">0</p></div>
                <div><p class="label-tech !text-[7px] text-red-500">Wh Out (-)</p><p id="whNeg" class="big-number">0</p></div>
            </div>
        </div>
    </main>

    <div class="nav-bar fixed bottom-0 left-0 right-0 h-20 flex justify-around items-center px-4 z-50">
        <button onclick="switchTab('home')" id="nav-home" class="tab-btn active flex flex-col items-center gap-1">
            <span class="text-xl">üìä</span><span class="text-[8px] font-bold uppercase tracking-wider">Dash</span>
        </button>
        <button onclick="switchTab('cells')" id="nav-cells" class="tab-btn flex flex-col items-center gap-1">
            <span class="text-xl">üîã</span><span class="text-[8px] font-bold uppercase tracking-wider">Cells</span>
        </button>
        <button onclick="switchTab('thermal')" id="nav-thermal" class="tab-btn flex flex-col items-center gap-1">
            <span class="text-xl">üå°Ô∏è</span><span class="text-[8px] font-bold uppercase tracking-wider">Temp</span>
        </button>
        <button onclick="switchTab('charts')" id="nav-charts" class="tab-btn flex flex-col items-center gap-1">
            <span class="text-xl">üìà</span><span class="text-[8px] font-bold uppercase tracking-wider">Stats</span>
        </button>
    </div>

    <div id="configModal" class="modal">
        <div class="glass-panel w-full max-w-lg p-8 mx-4">
            <h2 class="text-xl font-bold label-tech text-white mb-6">Cloud Configuration</h2>
            <textarea id="fbInput" class="w-full h-48 bg-black/50 border border-white/10 rounded-2xl p-4 text-[10px] text-emerald-400 outline-none mb-6" placeholder='Paste Firebase JSON here...'></textarea>
            <button onclick="saveCfg()" class="w-full bg-amber-600 hover:bg-amber-500 py-4 rounded-2xl font-bold label-tech text-white transition-all">Save & Connect</button>
            <button onclick="closeCfg()" class="w-full mt-3 text-slate-500 label-tech py-2">Cancel</button>
        </div>
    </div>

    <script>
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('nav-' + tabId).classList.add('active');
        }
        function openCfg() { document.getElementById('configModal').style.display = 'flex'; }
        function closeCfg() { document.getElementById('configModal').style.display = 'none'; }
        function saveCfg() {
            const input = document.getElementById('fbInput');
            if (input && input.value) {
                localStorage.setItem('bms_v48_cloud', input.value);
                location.reload();
            } else { alert("Masukkan JSON konfigurasi terlebih dahulu."); }
        }
        function toggleLog() {
            const content = document.getElementById('historyContent');
            if(content.classList.contains('collapsed')) content.classList.replace('collapsed', 'expanded');
            else content.classList.replace('expanded', 'collapsed');
        }
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => console.log("SW OK")).catch(err => console.error("SW Fail"));
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, onValue, query as rtdbQuery, limitToLast, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const db = new Dexie("BMS_History_DB");
        db.version(1).stores({ history: '++id, ts, w, v, a, t, tb' });

        let liveMode = true;
        let lastErrorCode = -1;

        const errorDict = { 0: "Sistem Normal", 1: "Tegangan Sel di Bawah Ambang Batas (2.5V)", 3: "Kesalahan Penulisan/Pembacaan Memori EEPROM", 4: "Proteksi Suhu: Terdeteksi Anomali Suhu Operasional", 5: "Aktivasi Sistem Trip: Gagal Reaktivasi Deteksi Arus Terpasang", 6: "Terdeteksi Hubungan Arus Pendek (Short Circuit)", 7: "Proteksi Arus Berlebih (Overcurrent Detected)", 8: "Tegangan Baterai Sangat Rendah: Diperlukan Pengisian Daya", 9: "Proteksi Pengisian: Tegangan Melebihi Batas Aman", 10: "Tegangan Baterai Rendah: Diperlukan Pengisian Daya", 11: "Kapasitas Rendah: Kurangi Beban" };

        const ctx = document.getElementById('unifiedChart').getContext('2d');
        const unifiedChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Watt', data: [], borderColor: '#3b82f6', borderWidth: 2, tension: 0.4, pointRadius: 0, yAxisID: 'yPower' },
                    { label: 'Volt', data: [], borderColor: '#10b981', borderWidth: 2, tension: 0.4, pointRadius: 0, yAxisID: 'yVolt' },
                    { label: 'Amp', data: [], borderColor: '#f59e0b', borderWidth: 1.5, tension: 0.4, pointRadius: 0, yAxisID: 'yAmp' },
                    { label: 'T-Mos', data: [], borderColor: '#ef4444', borderWidth: 1, tension: 0.4, pointRadius: 0, yAxisID: 'yTemp', hidden: true },
                    { label: 'T-Batt', data: [], borderColor: '#a855f7', borderWidth: 1, tension: 0.4, pointRadius: 0, yAxisID: 'yTemp', hidden: true }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false } },
                scales: { x: { display: false }, yPower: { display: false }, yVolt: { display: false }, yAmp: { display: false }, yTemp: { display: false } }
            }
        });

        window.toggleDataset = (index) => {
            const meta = unifiedChart.getDatasetMeta(index);
            const btn = document.getElementById(`btn-${index}`);
            meta.hidden = meta.hidden === null ? !unifiedChart.data.datasets[index].hidden : null;
            if (meta.hidden) btn.classList.add('opacity-30', 'grayscale');
            else btn.classList.remove('opacity-30', 'grayscale');
            unifiedChart.update();
        };

        const saved = localStorage.getItem('bms_v48_cloud');
        if(saved) {
            try {
                const config = JSON.parse(saved);
                const app = initializeApp(config);
                const rtdb = getDatabase(app);
                
                const checkAndSync = async () => {
                    const localCount = await db.history.count();
                    if (localCount < 5) await syncFromRTDB(rtdb);
                };
                checkAndSync();

                onValue(ref(rtdb, 'bms_live'), (snap) => { if(snap.val()) updateUI(snap.val()); });
            } catch(e) { console.error(e); }
        } else { openCfg(); }

        async function syncFromRTDB(rtdb) {
            const updateLabel = document.getElementById('lastUpdate');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('syncProgressBar');
            updateLabel.innerText = "Requesting Data...";
            progressContainer.classList.remove('hidden');
            try {
                const historyRef = ref(rtdb, 'bms_history');
                const recentQuery = rtdbQuery(historyRef, limitToLast(50000)); 
                const snapshot = await get(recentQuery);
                if (snapshot.exists()) {
                    const cloudData = [];
                    const dataObj = snapshot.val();
                    const keys = Object.keys(dataObj);
                    const totalData = keys.length;
                    keys.forEach((key, index) => {
                        const d = dataObj[key];
                        if (d.ts) {
                            cloudData.push({ ts: d.ts, w: Number((d.p || 0).toFixed(2)), v: Number((d.v || 0).toFixed(2)), a: Number((d.a || 0).toFixed(2)), t: Number((d.tM || 0).toFixed(2)), tb: Number((d.tB || 0).toFixed(2)) });
                        }
                        if (index % 1000 === 0) progressBar.style.width = Math.round((index / totalData) * 100) + '%';
                    });
                    await db.history.bulkPut(cloudData);
                    updateLabel.innerText = "Sync Complete";
                    if (!liveMode) window.handleDurationChange();
                }
            } catch (err) { console.error(err); }
            finally { setTimeout(() => progressContainer.classList.add('hidden'), 5000); }
        }

        function updateUI(d) {
            updateTimeRemaining(d.cChg || 0, d.cDis || 0);
            update('soc', Math.round(d.soc || 0));
            update('current', (d.a || 0).toFixed(1));
            update('power', (d.p || 0).toFixed(0));
            update('vTotal', (d.v || 0).toFixed(2) + 'V');
            update('v1', (d.v1 || 0).toFixed(3)); update('v2', (d.v2 || 0).toFixed(3));
            update('v3', (d.v3 || 0).toFixed(3)); update('v4', (d.v4 || 0).toFixed(3));
            update('whNow', (d.whN || 0).toFixed(0));
            update('cycles', (d.cyc || 0)); update('soh', (d.soh || 0).toFixed(1) + '%');
            update('usagePer', (d.uP || 0).toFixed(1) + '%');
            update('tBatt', (d.tB || 0).toFixed(1) + '¬∞C');
            update('tMos', (d.tM || 0).toFixed(1) + '¬∞C');
            update('whPos', (d.wP || 0).toFixed(1)); update('whNeg', (d.wN || 0).toFixed(1));

            document.getElementById('socCircle').style.strokeDashoffset = 534 - (534 * (d.soc || 0) / 100);
            document.getElementById('rChg').style.opacity = d.rC > 0.5 ? "1" : "0.2";
            document.getElementById('rDis').style.opacity = d.rD > 0.5 ? "1" : "0.2";

            const currentSnapshot = `${d.e1}-${d.e2}-${d.e3}-${d.e4}-${d.e5}-${d.err}`;
            if (currentSnapshot !== lastErrorCode) {
                const historyBox = document.getElementById('securityHistory');
                if(historyBox && historyBox.innerHTML.includes("Menunggu")) historyBox.innerHTML = "";
                let logEntries = [];
                ['e1', 'e2', 'e3', 'e4', 'e5'].forEach(key => { if (d[key] > 0) logEntries.push({ time: d[key + '_time'] || "--:--", msg: errorDict[d[key]] || "Err", isMain: false }); });
                if (d.err > 0) logEntries.unshift({ time: d.err_time || "--:--", msg: errorDict[d.err] || "System Error", isMain: true });
                logEntries.forEach(item => {
                    const entry = document.createElement('div');
                    entry.className = "history-entry mb-2 animate-pulse";
                    entry.innerHTML = `<span class="text-slate-500">${item.time}</span> <span class="${item.isMain?'text-red-400':'text-orange-400'}">${item.msg}</span>`;
                    historyBox.prepend(entry);
                });
                lastErrorCode = currentSnapshot;
                const card = document.getElementById('errorCard'), txt = document.getElementById('errText'), dot = document.getElementById('statusDot');
                if (d.err !== 0) {
                    card.classList.replace('border-emerald-500', 'border-red-500'); txt.innerText = errorDict[d.err]; txt.classList.replace('text-emerald-500', 'text-red-500'); dot.className = "h-3 w-3 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444]";
                } else {
                    card.classList.replace('border-red-500', 'border-emerald-500'); txt.innerText = "System Secure"; txt.classList.replace('text-red-500', 'text-emerald-500'); dot.className = "h-3 w-3 rounded-full bg-emerald-500 shadow-[0_0_8px_#10b981]";
                }
            }

            if(d.ts) {
                document.getElementById('lastUpdate').innerText = new Date(d.ts).toLocaleTimeString();
                db.history.add({ ts: d.ts, w: d.p || 0, v: d.v || 0, a: d.a || 0, t: d.tM || 0, tb: d.tB || 0 });
            }

            if(liveMode) {
                if(unifiedChart.data.labels.length > 50) { 
                    unifiedChart.data.labels.shift(); 
                    unifiedChart.data.datasets.forEach(ds => ds.data.shift()); 
                }
                unifiedChart.data.labels.push(""); 
                unifiedChart.data.datasets[0].data.push(Number((d.p || 0).toFixed(1)));
                unifiedChart.data.datasets[1].data.push(Number((d.v || 0).toFixed(2)));
                unifiedChart.data.datasets[2].data.push(Number((d.a || 0).toFixed(1)));
                unifiedChart.data.datasets[3].data.push(Number((d.tM || 0).toFixed(2)));
                unifiedChart.data.datasets[4].data.push(Number((d.tB || 0).toFixed(2)));
                unifiedChart.update('none');
            }
        }

        window.handleDurationChange = async () => {
            const mode = document.getElementById('chartDuration').value;
            const progress = document.getElementById('syncProgressBar'), container = document.getElementById('progressContainer');
            
            if (mode === 'live') { 
                liveMode = true; 
                // RESET DATA AGAR TIDAK HANG
                unifiedChart.data.labels = [];
                unifiedChart.data.datasets.forEach(ds => ds.data = []);
                unifiedChart.update();
                return; 
            }
            
            liveMode = false; container.classList.remove('hidden');
            const now = Date.now();
            let start = mode === '12h' ? now - 43200000 : mode === '24h' ? now - 86400000 : now - 604800000;
            
            const oldDataThreshold = now - (14 * 86400000);
            await db.history.where('ts').below(oldDataThreshold).delete();
            
            const allData = await db.history.where('ts').aboveOrEqual(start).toArray();
            unifiedChart.data.labels = allData.map(d => new Date(d.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
            unifiedChart.data.datasets[0].data = allData.map(d => d.w);
            unifiedChart.data.datasets[1].data = allData.map(d => d.v);
            unifiedChart.data.datasets[2].data = allData.map(d => d.a);
            unifiedChart.data.datasets[3].data = allData.map(d => d.t);
            unifiedChart.data.datasets[4].data = allData.map(d => d.tb);
            
            unifiedChart.update();
            setTimeout(() => container.classList.add('hidden'), 1000);
        };

        function updateTimeRemaining(ahIn, ahOut) {
            const currentFromUI = parseFloat(document.getElementById('current').textContent) || 0;
            const vTotalVal = parseFloat(document.getElementById('vTotal').textContent) || 1;
            const whNowVal = parseFloat(document.getElementById('whNow').textContent) || 0;
            const ahNowVal = whNowVal / vTotalVal;

            let timeRemainingText;
            if (Math.abs(currentFromUI) < 0.1) timeRemainingText = "Diam";
            else if (currentFromUI > 0) {
                const capToFull = ahIn - ahNowVal;
                timeRemainingText = formatTime(capToFull > 0 ? capToFull / currentFromUI : 0) + " (TTF)";
            } else {
                timeRemainingText = formatTime(ahNowVal / Math.abs(currentFromUI)) + " (TTE)";
            }
            document.getElementById('time-remaining-value').textContent = `Waktu Sisa: ${timeRemainingText}`;
        }

        function formatTime(hours) {
            if (hours === Infinity || isNaN(hours)) return "--";
            if (hours <= 0) return "0m";
            const h = Math.floor(hours), m = Math.round((hours - h) * 60);
            return h > 0 ? `${h}j ${m}m` : `${m}m`;
        }

        function update(id, v) { const e = document.getElementById(id); if(e) e.innerText = v; }
    </script>
</body>
</html>
