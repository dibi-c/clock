<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORE BMS REMOTE | DECADE EDITION v5.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<link href="https://fonts.cdnfonts.com/css/bauhaus-93" rel="stylesheet">
<link rel="manifest" id="my-manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;800&display=swap');
        
        :root { 
            --accent: #f59e0b; 
            --bg: #020408;
            --glass: rgba(10, 14, 23, 0.7);
        }

        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background: var(--bg); color: #f8fafc;
            background-image: 
                linear-gradient(to bottom, rgba(2, 4, 8, 0.9), rgba(2, 4, 8, 1)),
                url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            min-height: 100vh;
        }

        .glass-panel { 
            background: var(--glass); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.03); 
            border-radius: 28px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
        }
        .glass-panel:hover { border-color: rgba(245, 158, 11, 0.2); }

        .big-number { font-family: 'JetBrains Mono', monospace; font-weight: 800; letter-spacing: -0.05em; }
        .label-tech { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.2em; color: #475569; }
        
        .progress-ring { transition: stroke-dashoffset 0.8s ease-in-out; }
        
        #securityHistory::-webkit-scrollbar { width: 4px; }
        #securityHistory::-webkit-scrollbar-track { background: transparent; }
        #securityHistory::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(20px); }
        .history-entry { font-family: 'JetBrains Mono', monospace; font-size: 10px; border-bottom: 1px solid rgba(255,255,255,0.03); padding: 4px 0; }
        
        /* Tirai Log Style */
        #historyContent { transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease; overflow: hidden; }
        #historyContent.collapsed { max-height: 0; opacity: 0; pointer-events: none; }
        #historyContent.expanded { max-height: 400px; opacity: 1; }


/* --- STYLE LOGO MODERN --- */
    .logo-container {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .dibi-box {
        height: 3.5rem;
        width: 3.5rem;
        background: linear-gradient(135deg, #ffbd44 0%, #ff8900 100%);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(255, 158, 11, 0.4);
        position: relative;
        overflow: hidden;
    }

    .dibi-box::after {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; height: 50%;
        background: linear-gradient(to bottom, rgba(255,255,255,0.3) 0%, transparent 100%);
    }

    .dibi-text {
        font-family: 'Bauhaus 93', 'Arial Round', sans-serif;
        font-size: 1.5rem;
        color: #000;
        letter-spacing: -1px;
        font-weight: bold;
    }

    .core-remote-text {
        font-family: 'Space Grotesk', sans-serif;
        font-weight: 700;
        font-size: 1.8rem;
        line-height: 1;
        letter-spacing: -0.02em;
        color: #ffffff;
    }

    .dot-orange { color: #f59e0b; }
        /* -------------------------- */


    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-[1600px] mx-auto">
        <nav class="flex justify-between items-center mb-8">
    <div class="logo-container">
        <div class="dibi-box">
            <span class="dibi-text">dibi</span>
        </div>
        <div>
            <h1 class="core-remote-text">CORE<span class="dot-orange">.</span>REMOTE</h1>
            <p class="label-tech">Decade Terminal v5.1 - Analytics Engine</p>
        </div>
    </div>


            <div class="flex items-center gap-4">
                <div id="progressContainer" class="hidden w-32 h-1 bg-white/5 rounded-full overflow-hidden mr-4">
                    <div id="syncProgressBar" class="h-full bg-amber-500 transition-all duration-300" style="width: 0%"></div>
                </div>

                <div id="syncBadge" class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-full border border-white/10">
                    <div id="statusPulse" class="h-2 w-2 rounded-full bg-amber-500 animate-pulse"></div>
                    <span class="label-tech text-white" id="lastUpdate">Connecting Cloud...</span>
                </div>
                <button onclick="openCfg()" class="p-3 bg-white/5 hover:bg-white/10 rounded-2xl transition-all">‚öôÔ∏è</button>
            </div>
        </nav>

        <div class="grid grid-cols-12 gap-6">
            <div class="col-span-12 lg:col-span-4 space-y-6">
                <div class="glass-panel p-8 flex flex-col items-center relative overflow-hidden">
                    <span class="label-tech mb-6">Energy Level</span>
                    <div class="relative flex items-center justify-center">
                        <svg class="w-64 h-64 transform -rotate-90">
                            <circle cx="128" cy="128" r="110" stroke="currentColor" stroke-width="8" fill="transparent" class="text-white/5" />
                            <circle id="socCircle" cx="128" cy="128" r="110" stroke="#f59e0b" stroke-width="12" fill="transparent" stroke-dasharray="691" stroke-dashoffset="691" stroke-linecap="round" class="progress-ring" />
                        </svg>
                        <div class="absolute text-center">
                            <span id="soc" class="big-number text-8xl">0</span>
                            <span class="text-2xl font-light text-slate-500">%</span>
                        </div>
                    </div>
   

       <div class="mt-4 text-center">
    <p class="label-tech opacity-40 !text-[7px] uppercase mb-0.5">Time Remaining</p>
    <p id="time-remaining-value" class="big-number text-sm text-slate-400 font-light tracking-tight">--</p>
</div>
                    <div class="grid grid-cols-2 gap-8 mt-10 w-full border-t border-white/5 pt-8">
                        <div class="text-center">
                            <p class="label-tech">Current (A)</p>
                            <p class="big-number text-3xl text-amber-500" id="current">0.00</p>
                        </div>
                        <div class="text-center border-l border-white/5">
                            <p class="label-tech">Load (W)</p>
                            <p class="big-number text-3xl text-blue-500" id="power">0</p>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 grid grid-cols-2 gap-4">
                    <div id="rChg" class="flex items-center justify-center gap-3 py-3 rounded-2xl bg-white/5 opacity-20 transition-all border border-white/5">
                        <span class="text-lg">‚ö°</span><span class="label-tech">Charging</span>
                    </div>
                    <div id="rDis" class="flex items-center justify-center gap-3 py-3 rounded-2xl bg-white/5 opacity-20 transition-all border border-white/5">
                        <span class="text-lg">üîå</span><span class="label-tech">Discharge</span>
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <span class="label-tech text-red-500">System Thermals</span>
                    <div class="flex justify-between mt-4">
                        <div class="bg-white/5 p-4 rounded-2xl w-[48%]">
                            <p class="label-tech !text-[8px]">Mosfet</p>
                            <p id="tMos" class="big-number text-2xl">0¬∞C</p>
                        </div>
                        <div class="bg-white/5 p-4 rounded-2xl w-[48%] border-l-2 border-orange-500">
                            <p class="label-tech !text-[8px]">Battery</p>
                            <p id="tBatt" class="big-number text-2xl text-orange-500">0¬∞C</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-8 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-6">
                            <span class="label-tech">Cell Voltages</span>
                            <span id="vTotal" class="big-number text-2xl text-white">0.00V</span>
                        </div>
                        <div class="grid grid-cols-4 gap-3">
                            <div class="text-center"><p class="label-tech !text-[7px]">C1</p><p id="v1" class="big-number text-sm">0.00</p></div>
                            <div class="text-center border-l border-white/5"><p class="label-tech !text-[7px]">C2</p><p id="v2" class="big-number text-sm">0.00</p></div>
                            <div class="text-center border-l border-white/5"><p class="label-tech !text-[7px]">C3</p><p id="v3" class="big-number text-sm">0.00</p></div>
                            <div class="text-center border-l border-white/5"><p class="label-tech !text-[7px]">C4</p><p id="v4" class="big-number text-sm">0.00</p></div>
                        </div>
                    </div>
                    <div class="glass-panel p-6">
                        <span class="label-tech">Energy Management</span>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div><p class="label-tech !text-[7px] opacity-50">Wh Design/Now</p><p class="text-xs font-bold"><span id="whDesign">0</span> / <span id="whNow" class="text-blue-400">0</span></p></div>
                            <div><p class="label-tech !text-[7px] opacity-50">Ah Design/Now</p><p class="text-xs font-bold"><span id="ahDesign">0.0</span> / <span id="ahNow" class="text-blue-400">0.0</span></p></div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex flex-col gap-1">
                            <span class="label-tech">Data Stream Analytics</span>
                            <div class="flex gap-4 text-[7px] font-bold">
                               <span class="text-blue-500">‚óè LOAD (W)</span> 
    <span class="text-emerald-500">‚óè VOLTAGE (V)</span> 
    <span class="text-orange-500">‚óè CURRENT (A)</span> 
    <span class="text-red-500">‚óè TEMP MOSFET</span>
    <span class="text-yellow-500">‚óè TEMP BATT</span>
                            </div>
                        </div>
                        <select id="chartDuration" onchange="window.handleDurationChange()" class="bg-black/50 border border-white/10 rounded-lg px-2 py-1 text-[10px] label-tech text-white outline-none">
                            <option value="live">Live Stream</option>
                            <option value="12h">Last 12 Hours</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                        </select>
                    </div>
                    <div class="h-[280px]"><canvas id="unifiedChart"></canvas></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div id="errorCard" class="glass-panel p-6 md:col-span-8 border-l-4 border-emerald-500 flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div id="statusDot" class="h-4 w-4 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]"></div>
                                <div>
                                    <p class="label-tech">Security Status</p>
                                    <h3 id="errText" class="big-number text-lg uppercase text-emerald-500 leading-tight">System Secure</h3>
                                </div>
                            </div>
                            <button onclick="toggleLog()" class="px-4 py-2 bg-white/5 hover:bg-white/10 rounded-xl border border-white/10 transition-all">
                                <span id="logBtnLabel" class="label-tech !text-[8px] text-white">Buka Tirai Log</span>
                            </button>
                        </div>
                        <div id="historyContent" class="collapsed border-t border-white/5 pt-4">
                            <p class="label-tech !text-[7px] mb-2">History Peristiwa</p>
                            <div id="securityHistory" class="max-h-32 overflow-y-auto pr-2">
                                <div class="history-entry text-slate-600 italic">Menunggu telemetri...</div>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel p-6 md:col-span-4">
                        <div class="flex justify-between items-center">
                            <span class="label-tech">Cycles / SOH</span>
                            <span id="soh" class="big-number text-blue-400 text-lg">0%</span>
                        </div>
                        <p id="cycles" class="big-number text-3xl mt-2">0</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-6">
                    <div class="glass-panel p-6">
                        <span class="label-tech">Charge & Discharge Stats</span>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div><p class="label-tech !text-[7px] text-emerald-500">Wh In (+)</p><p id="whPos" class="big-number text-xl">0</p></div>
                            <div><p class="label-tech !text-[7px] text-red-500">Wh Out (-)</p><p id="whNeg" class="big-number text-xl">0</p></div>
                        </div>
                    </div>
                    <div class="glass-panel p-6">
                        <span class="label-tech">Capacity Lifecycle</span>
                        <div class="flex justify-between items-end mt-4">
                            <div><p class="label-tech !text-[7px]">Usage Intensity</p><p id="usagePer" class="big-number text-2xl text-amber-500">0%</p></div>
                            <div class="text-right">
                                <p class="label-tech !text-[8px] opacity-50">Ah In/Out</p>
                                <p class="text-[10px] value-mono"><span id="capChg">0.0</span> / <span id="capDis">0.0</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="configModal" class="modal">
        <div class="glass-panel w-full max-w-lg p-8">
            <h2 class="text-xl font-bold label-tech text-white mb-6">Cloud Configuration</h2>
            <textarea id="fbInput" class="w-full h-48 bg-black/50 border border-white/10 rounded-2xl p-4 text-[10px] value-mono text-emerald-400 outline-none mb-6" placeholder='Paste Firebase JSON here...'></textarea>
            <button onclick="saveCfg()" class="w-full bg-amber-600 hover:bg-amber-500 py-4 rounded-2xl font-bold label-tech text-white transition-all">Save & Connect</button>
            <button onclick="closeCfg()" class="w-full mt-3 text-slate-500 label-tech py-2">Cancel</button>
        </div>
    </div>


<script>
  // --- 1. PENGECEKAN MANIFEST ---
  const manifestLink = document.getElementById('my-manifest');

  // Cek apakah file manifest.json bisa diakses
  fetch(manifestLink.href)
    .then(response => {
      if (response.ok) {
        console.log("‚úÖ Manifest ditemukan: File manifest.json berhasil dimuat.");
      } else {
        console.error("‚ùå Manifest Gagal: File tidak ditemukan (404). Pastikan nama file dan folder sudah benar.");
      }
    })
    .catch(err => {
      console.error("‚ùå Manifest Gagal: Terjadi kesalahan jaringan atau masalah CORS.", err);
    });

  // --- 2. PENGECEKAN SERVICE WORKER ---
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then((reg) => {
        console.log("‚úÖ Service Worker: Terdaftar dengan sukses.");
      })
      .catch((err) => {
        console.error("‚ùå Service Worker Gagal: Tidak bisa didaftarkan.");
        
        // Alasan-alasan kegagalan Service Worker & Manifest
        if (window.location.protocol === 'file:') {
          console.error("üëâ ALASAN: Anda membuka file secara langsung (file:///), bukan lewat Server/Hosting.");
        } else if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
          console.error("üëâ ALASAN: PWA mewajibkan HTTPS. GitHub Pages sudah HTTPS, pastikan Anda membukanya lewat link tersebut.");
        } else {
          console.error("üëâ ALASAN: File 'sw.js' mungkin tidak ada di folder, atau ada kesalahan penulisan kode di dalamnya.");
        }
      });
  }

  // --- 3. PENGECEKAN SYARAT INSTALASI (PWA CRITERIA) ---
  window.addEventListener('beforeinstallprompt', (e) => {
    console.log("üöÄ SIAP INSTAL: Browser mengonfirmasi Manifest & SW sudah memenuhi syarat aplikasi!");
  });

  // Jika setelah 3 detik event install tidak muncul, beri peringatan kemungkinan penyebabnya
  setTimeout(() => {
    if (!window.isAppInstallable) { // Variabel indikator buatan sendiri
      console.log("‚ÑπÔ∏è Tips: Jika tombol install belum muncul, cek tab 'Application' > 'Manifest' di Inspect Element untuk melihat error spesifik dari Chrome.");
    }
  }, 3000);
</script>


<script>
    function openCfg() {
        document.getElementById('configModal').style.display = 'flex';
    }

    function closeCfg() {
        document.getElementById('configModal').style.display = 'none';
    }

    function saveCfg() {
        const input = document.getElementById('fbInput');
        if (input && input.value) {
            localStorage.setItem('bms_v48_cloud', input.value);
            location.reload();
        } else {
            alert("Masukkan JSON konfigurasi terlebih dahulu.");
        }
    }

    // Fungsi Toggle Tirai
    function toggleLog() {
        const content = document.getElementById('historyContent');
        const label = document.getElementById('logBtnLabel');
        if(content.classList.contains('collapsed')) {
            content.classList.replace('collapsed', 'expanded');
            label.innerText = "Tutup Tirai Log";
        } else {
            content.classList.replace('expanded', 'collapsed');
            label.innerText = "Buka Tirai Log";
        }
    }
    
    window.openCfg = openCfg;
    window.closeCfg = closeCfg;
    window.saveCfg = saveCfg;
    window.toggleLog = toggleLog;
</script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, onValue, query as rtdbQuery, limitToLast, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
        import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const db = new Dexie("BMS_History_DB");
        db.version(1).stores({
            history: '++id, ts, w, v, a, t, tb'
        });

        let firestore = null;
        let liveMode = true;
        let lastErrorCode = -1;

async function syncFromRTDB(rtdb) {
    const updateLabel = document.getElementById('lastUpdate');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('syncProgressBar');

    updateLabel.innerText = "Downloading Cloud...";
    progressContainer.classList.remove('hidden');
    progressBar.style.width = '20%';

    try {
        // Ambil 1000 data terakhir dari node 'bms_history'
        // Sesuaikan nama 'bms_history' dengan nama node di Firebase Anda
        const historyRef = ref(rtdb, 'bms_history');
        const recentQuery = rtdbQuery(historyRef, limitToLast(1000000));
        const snapshot = await get(recentQuery);

        if (snapshot.exists()) {
            const cloudData = [];
            snapshot.forEach((child) => {
                const d = child.val();
                cloudData.push({
                    ts: d.ts,
                    w: d.p || 0,
                    v: d.v || 0,
                    a: d.a || 0,
                    t: d.tM || 0, // Mosfet
                    tb: d.tB || 0 // Battery
                });
            });

            progressBar.style.width = '60%';
            // Simpan massal ke Dexie
            await db.history.bulkPut(cloudData);
            
            progressBar.style.width = '100%';
            updateLabel.innerText = "Cloud Synced";
            
            // Otomatis pindah ke tampilan 12 jam agar grafik langsung muncul
            document.getElementById('chartDuration').value = '12h';
            window.handleDurationChange();
        }
    } catch (err) {
        console.error("Sync Error:", err);
        updateLabel.innerText = "Sync Failed";
    } finally {
        setTimeout(() => progressContainer.classList.add('hidden'), 2000);
    }
}

function updateTimeRemaining(ahIn, ahOut) {
    const timeRemainingElement = document.getElementById('time-remaining-value');
    if (!timeRemainingElement) return;

    const currentFromUI = parseFloat(document.getElementById('current').textContent) || 0;
    const capRemFromUI = parseFloat(document.getElementById('ahNow').textContent) || 0;

    let currentRem = currentFromUI;
    let fullCap = ahIn;
    let dchgCap = ahOut;

    let diff = Math.max(0, fullCap - dchgCap);
    let remainingCap = Math.max(0, capRemFromUI - diff);

    let timeRemainingText;

    if (Math.abs(currentRem) < 0.1) {
        timeRemainingText = "Diam";
    } 
    else if (currentRem > 0) {
        const capToFull = fullCap - capRemFromUI;
        const hours = capToFull > 0 ? capToFull / currentRem : 0;
        timeRemainingText = formatTime(hours) + " (TTF)";
    } 
    else {
        const hours = remainingCap / Math.abs(currentRem);
        timeRemainingText = formatTime(hours) + " (TTE)";
    }

    timeRemainingElement.textContent = `Waktu Sisa: ${timeRemainingText}`;
}

function formatTime(hours) {
    if (hours === Infinity || isNaN(hours)) return "--";
    if (hours <= 0) return "0m";
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    return h > 0 ? `${h}j ${m}m` : `${m}m`;
}

        const errorDict = {
            0: "Normal Operation",
            1: "Cell Undervoltage",
            2: "Reserved Status",
            3: "EEPROM Memory Error",
            4: "Thermal Anomaly",
            5: "Activation Failure",
            6: "Short Circuit Detected",
            7: "Overcurrent Protection",
            8: "Critical Battery",
            9: "Charge Overvoltage",
            10: "Low Battery",
            11: "Load Overload"
        };

        const ctx = document.getElementById('unifiedChart').getContext('2d');
        const unifiedChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
   datasets: [
    { label: 'Watt', data: [], borderColor: '#3b82f6', borderWidth: 2, tension: 0.4, pointRadius: 0, yAxisID: 'y' },
    { label: 'Volt', data: [], borderColor: '#10b981', borderWidth: 2, tension: 0.4, pointRadius: 0, yAxisID: 'y' },
    { label: 'Amp', data: [], borderColor: '#f59e0b', borderWidth: 1.5, tension: 0.4, pointRadius: 0, yAxisID: 'y1' },
    { label: 'T-Mos', data: [], borderColor: '#ef4444', borderWidth: 1, borderDash: [5, 5], tension: 0.4, pointRadius: 0, yAxisID: 'y1' },
    { label: 'T-Batt', data: [], borderColor: '#eab308', borderWidth: 1, borderDash: [5, 5], tension: 0.4, pointRadius: 0, yAxisID: 'y1' }
]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    x: { display: false }, 
                    y: { position: 'left', grid: { color: 'rgba(255,255,255,0.02)' }, ticks: { color: '#475569', font: { size: 9 } } },
                    y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#64748b', font: { size: 8 } } }
                }
            }
        });
        
 const saved = localStorage.getItem('bms_v48_cloud');
if(saved) {
    try {
        const config = JSON.parse(saved);
        const app = initializeApp(config);
        const rtdb = getDatabase(app);
        firestore = getFirestore(app);
        document.getElementById('fbInput').value = saved;

        // --- BAGIAN PENGECEKAN DATA KOSONG ---
        const checkAndSync = async () => {
            const localCount = await db.history.count();
            if (localCount < 5) { // Jika data lokal < 5 poin, download dari cloud
                await syncFromRTDB(rtdb);
            }
        };
        checkAndSync();
        // -------------------------------------

        onValue(ref(rtdb, 'bms_live'), (snap) => { 
            if(snap.val()) updateUI(snap.val()); 
        });
    } catch(e) { console.error(e); }
} else { openCfg(); }

function updateUI(d) {
    const ahIn = d.cChg || 0;
    const ahOut = d.cDis || 0;
    updateTimeRemaining(ahIn, ahOut);

update('soc', Math.round(d.soc || 0));
update('current', (d.a || 0).toFixed(1));
update('power', (d.p || 0).toFixed(0));
update('vTotal', (d.v || 0).toFixed(2) + 'V');
update('v1', (d.v1 || 0).toFixed(3)); 
update('v2', (d.v2 || 0).toFixed(3));
update('v3', (d.v3 || 0).toFixed(3)); 
update('v4', (d.v4 || 0).toFixed(3));
update('whDesign', (d.whD || 0).toFixed(0)); 
update('whNow', (d.whN || 0).toFixed(0)); 
update('ahDesign', (d.ahD || 0).toFixed(1)); 
update('ahNow', (d.ahN || 0).toFixed(1));
update('whPos', (d.wP || 0).toFixed(1)); 
update('whNeg', (d.wN || 0).toFixed(1));
update('cycles', (d.cyc || 0)); 
update('soh', (d.soh || 0).toFixed(1) + '%');
update('capChg', (d.cChg || 0).toFixed(1)); 
update('capDis', (d.cDis || 0).toFixed(1));
update('usagePer', (d.uP || 0).toFixed(1) + '%');
update('tBatt', (d.tB || 0).toFixed(1) + '¬∞C');
update('tMos', (d.tM || 0).toFixed(1) + '¬∞C');

            const offset = 691 - (691 * (d.soc || 0) / 100);
            document.getElementById('socCircle').style.strokeDashoffset = offset;
            document.getElementById('rChg').style.opacity = d.rC > 0.5 ? "1" : "0.2";
            document.getElementById('rDis').style.opacity = d.rD > 0.5 ? "1" : "0.2";

// SNAPSHOT UNTUK HISTORY
const currentSnapshot = `${d.e1}-${d.e2}-${d.e3}-${d.e4}-${d.e5}-${d.err}`;

if (currentSnapshot !== lastErrorCode) {
    const historyBox = document.getElementById('securityHistory');
    if(historyBox && historyBox.innerHTML.includes("Menunggu")) historyBox.innerHTML = "";

    // Kumpulkan semua detail error sensor untuk log
    let logMessages = [];
    ['e1', 'e2', 'e3', 'e4', 'e5'].forEach(key => {
        if (d[key] > 0) logMessages.push(errorDict[d[key]] || `Sensor ${key.toUpperCase()}: ${d[key]}`);
    });

    // Pesan utama dari d.err
    const mainErrText = errorDict[d.err] || (d.err > 0 ? `System Error: ${d.err}` : "Normal Operation");
    if (!logMessages.includes(mainErrText)) logMessages.unshift(mainErrText);

    // Tambah baris baru ke History Log
    const entry = document.createElement('div');
    entry.className = "history-entry mb-2 border-b border-white/5 pb-2 animate-pulse";
    const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    
    // Warna teks di dalam log tetap mengikuti status apakah sistem error atau tidak
    const logTextColor = d.err > 0 ? 'text-red-400' : 'text-emerald-400';

    entry.innerHTML = `
        <div class="flex justify-between items-start">
            <span class="text-[9px] text-slate-500 font-mono">${timeStr}</span>
            <div class="text-right">
                ${logMessages.map(msg => `
                    <p class="text-[10px] ${logTextColor} font-medium leading-tight">
                        ${msg}
                    </p>
                `).join('')}
            </div>
        </div>
    `;

    if(historyBox) {
        historyBox.prepend(entry);
        setTimeout(() => entry.classList.remove('animate-pulse'), 3000);
        if(historyBox.children.length > 20) historyBox.lastElementChild.remove();
    }

    lastErrorCode = currentSnapshot;

    // FOKUS PERBAIKAN: LOGIKA WARNA KARTU UTAMA
    const card = document.getElementById('errorCard');
    const errTextElement = document.getElementById('errText');
    const statusDot = document.getElementById('statusDot');

    if (card && errTextElement) {
        // HANYA JIKA d.err > 0 (BUKAN 0), MAKA MERAH
        if (d.err !== 0) {
            card.classList.replace('border-emerald-500', 'border-red-500');
            errTextElement.innerText = errorDict[d.err] || `Warning: Err ${d.err}`;
            errTextElement.classList.replace('text-emerald-500', 'text-red-500');
            statusDot.className = "h-4 w-4 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]";
        } 
        // JIKA d.err == 0, MAKA HIJAU (NORMAL)
        else {
            card.classList.replace('border-red-500', 'border-emerald-500');
            errTextElement.innerText = "System Secure";
            errTextElement.classList.replace('text-red-500', 'text-emerald-500');
            statusDot.className = "h-4 w-4 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]";
        }
    }
}

            if(d.ts) {
                document.getElementById('lastUpdate').innerText = new Date(d.ts).toLocaleTimeString();
                db.history.add({ ts: d.ts, w: d.p || 0, v: d.v || 0, a: d.a || 0, t: d.tM || 0, tb: d.tB || 0 });
            }

  if(liveMode) {
    if(unifiedChart.data.labels.length > 50) {
        unifiedChart.data.labels.shift();
        unifiedChart.data.datasets.forEach(ds => ds.data.shift());
    }
    unifiedChart.data.labels.push(""); 
    unifiedChart.data.datasets[0].data.push(d.p || 0);
    unifiedChart.data.datasets[1].data.push(d.v || 0);
    unifiedChart.data.datasets[2].data.push(d.a || 0);
    unifiedChart.data.datasets[3].data.push(d.tM || 0);
    unifiedChart.data.datasets[4].data.push(d.tB || 0);
    unifiedChart.update('none');
  }
}

window.handleDurationChange = async () => {
    const mode = document.getElementById('chartDuration').value;
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('syncProgressBar');
    const updateLabel = document.getElementById('lastUpdate');

    if (mode === 'live') {
        liveMode = true;
        unifiedChart.data.labels = [];
        unifiedChart.data.datasets.forEach(ds => ds.data = []);
        unifiedChart.update();
        progressContainer.classList.add('hidden');
        return;
    }

    liveMode = false;
    progressContainer.classList.remove('hidden');
    progressBar.style.width = '10%';
    updateLabel.innerText = "Syncing Local...";

    const now = Date.now();
    let start;
    if (mode === '12h') start = now - (12*3600000);
    else if (mode === '24h') start = now - (24*3600000);
    else if (mode === '7d') start = now - (7*86400000);

    try {
        progressBar.style.width = '40%';
        const oldDataThreshold = now - (14 * 86400000);
        await db.history.where('ts').below(oldDataThreshold).delete();
        progressBar.style.width = '90%';
        const allData = await db.history.where('ts').aboveOrEqual(start).toArray();
        unifiedChart.data.labels = allData.map(d => new Date(d.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
        unifiedChart.data.datasets[0].data = allData.map(d => d.w);
        unifiedChart.data.datasets[1].data = allData.map(d => d.v);
        unifiedChart.data.datasets[2].data = allData.map(d => d.a);
        unifiedChart.data.datasets[3].data = allData.map(d => d.t);
        unifiedChart.data.datasets[4].data = allData.map(d => d.tb); // <--- TAMBAHKAN INI (Mapping ke T-Batt)
        unifiedChart.update('none');
        progressBar.style.width = '100%';
        updateLabel.innerText = `${allData.length} Pts Loaded`;
        setTimeout(() => progressContainer.classList.add('hidden'), 2000);
    } catch (err) {
        console.error(err);
        updateLabel.innerText = "Sync Error";
    }
};

function update(id, v) { const e = document.getElementById(id); if(e) e.innerText = v; }
</script>
</body>
</html>
